<!DOCTYPE html>
<head>
    <script src="https://cdn.plot.ly/plotly-3.3.0.min.js" charset="utf-8"></script>
</head>
<body>
    <div id="map"></div>
    <script type="module">
        async function fetch_json(file){
            try{
                const res = await fetch(file);

                if (!res.ok){
                    throw new Error(`Bad status: ${res.status}`);
                }

                return await res.json();
            } catch(error){
                console.error(`${error}`);
            }
        }

        function reformat_date(str){
            const date_str = new Date(str);
            return `${date_str.getFullYear()}-${date_str.getMonth()}-${date_str.getDate()}`;
        }

        const fires_json = await fetch_json("data/ca_fires_pc.geojson");

        const fire_names = fires_json.features.map(
            item => item.properties.FIRE_NAME
        );
        const fire_color = fires_json.features.map(
            item => item.properties.GIS_ACRES
        );
        const fire_alarm_date = fires_json.features.map(
            item => item.properties.ALARM_DATE
        );

        //const zip = (a, b) => a.map((val, i) => val + " " + b[i]);

        // https://plotly.com/javascript/reference/choropleth/
        var data = [{
            type: "choroplethmap",
            locations: fire_names,
            z: fire_color,
            geojson: fires_json,
            featureidkey: "properties.FIRE_NAME",
            //hovertemplate: "z: %{fire_color}"
            //hovertext: fire_alarm_date, // gets associated with the location text
            marker : {opacity: 0.75},
        }];

        var layout = {
            title: {
                text: "Recent Large Fire Perimeters (GT 5000 acres)"
            },
            map: {
                center: {lon: -117, lat: 35},
                zoom: 3.5,
            }
        };

        Plotly.newPlot("map", data, layout, 
            {margin: { t: 0, l: 0, r: 0, b: 0 }},
            {responsive: true}
        );

        // TODO idea: info box shows up top right instead of alert?
        // TODO idea: collect stats that can be graphed; fire size, histogram of cause of fire, year of fire occurences.
        // other cool events: https://plotly.com/javascript/plotlyjs-events/
        var myPlot = document.getElementById("map");

        myPlot.on("plotly_click", function(data) {
            const p = data.points[0].properties;
            //console.log(p);
            // bless chatgpt for somehow finding this from the depths of hell: https://34c031f8-c9fd-4018-8c5a-4159cdff6b0d-cdn-endpoint.azureedge.net/-/media/calfire-website/what-we-do/fire-resource-assessment-program---frap/data-dictionary-updated-april-2025.pdf?hash=371C2A47D6A96261C91E0008A1BABC20&rev=99e4dccd9d654a6f9ed9556c0b7e3445
            const fire_cause = [
                "null", "Lightning", "Equipment Use", "Smoking", "Campfire",
                "Debris", "Railroad", "Arson", "Playing with fire", 
                "Miscellaneous", "Vehicle", "Powerline", "Firefighter Training",
                "Non-Firefighter Training", "Unknown/Unidentified",
                "Structure", "Aircraft", "Volcanic"
            ]
            // ...why it gotta be this ugly
            const message = `Fire Name: ${p.FIRE_NAME}
Acre burned: ${p.GIS_ACRES}
Alarm Date: ${p.ALARM_DATE}
Containment Date: ${p.CONT_DATE}
Cause: ${fire_cause[parseInt(p.CAUSE)]}
Additional Comments: ${p.COMMENTS ?? "None"}`;
            alert(message);
        });
    </script>
</body>
<style>
  html, body {
    height: 100%;
    margin: 0;
  }
  #map {
    width: 100vw;
    height: 100vh;
  }
</style>
</html>
