<!DOCTYPE html>
<head>
    <script src="https://cdn.plot.ly/plotly-3.3.0.min.js" charset="utf-8"></script>
    <style>
        .container {
            width: 100%;
            margin: auto;
        }

        .row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }

        .small-plot {
            flex: 1;
            height: 500px;
        }

        .large-plot {
            width: 100%;
            height: 800px;
        }

        .loading-overlay {
            /* position over parent, centered */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;

            background-color: rgba(255, 255, 255, 0.8); /* semi-transparent bg */
            z-index: 10; /* Ensure the spinner is above the graph */
            visibility: hidden; 
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }

        .loading-overlay.show {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map" class="large-plot">
            <div class="loading-overlay" id="loading-spinner">
                <div class="spinner"></div>
            </div>
        </div>
        <div class="row">
            <div id="bar1" class="small-plot"></div>
            <div id="bar2" class="small-plot"></div>
        </div>
        <div id="scatter1" class="large-plot"></div>
    </div>

    <script type="module">
        async function fetch_json(file){
            try{
                const res = await fetch(file);

                if (!res.ok){
                    throw new Error(`Bad status: ${res.status}`);
                }

                return await res.json();
            } catch(error){
                console.error(`${error}`);
            }
        }

        function frequency_of(arr, n_buckets){
            const freq = arr.reduce(
                (acc, e) => acc.set(e, (acc.get(e) || 0) + 1), new Map()
            );
            const range = Array.from({ length: n_buckets }, (_, i) => i + 1);
            return range.map(idx => freq.has(idx) ? freq.get(idx) : 0);
        }

        function show_spinner(){
            document.getElementById("loading-spinner").classList.add("show");
        }

        function hide_spinner(){
            document.getElementById("loading-spinner").classList.remove("show");
        }

        show_spinner();

        const fires_json = await fetch_json("data/ca_fires_pc.geojson");

        const fire_names = fires_json.features.map(
            item => item.properties.FIRE_NAME
        );
        const fire_acres = fires_json.features.map(
            item => item.properties.GIS_ACRES
        );
        const fire_alarm_date = fires_json.features.map(
            item => item.properties.ALARM_DATE
        );
        const fire_months = fire_alarm_date.map(
            datestr => (new Date(datestr)).getMonth() + 1
        );
        const month_freq = frequency_of(fire_months, 12);
        const months = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        const fire_cause = [
            "null", "Lightning", "Equipment Use", "Smoking", "Campfire",
            "Debris", "Railroad", "Arson", "Playing with fire", 
            "Miscellaneous", "Vehicle", "Powerline", "Firefighter Training",
            "Non-Firefighter Training", "Unknown/Unidentified",
            "Structure", "Aircraft", "Volcanic"
        ];
        const fire_cause_int = fires_json.features.map(
            item => item.properties.CAUSE
        );
        const cause_freq = frequency_of(fire_cause_int, fire_cause.length - 1);
        const fire_contain_date = fires_json.features.map(
            item => item.properties.CONT_DATE
        );
        const days_to_contain = fire_contain_date.map((contain_date, idx) => {
            const alarm_date = fire_alarm_date[idx];
            const end = contain_date == null ? null : new Date(contain_date);
            const start = alarm_date == null ? null : new Date(alarm_date);
            const diff = (end == null || start == null) ? -1 : end - start;
            return (diff) / (1000 * 60 * 60 * 24);
        });

        // https://plotly.com/javascript/reference/choropleth/
        var data = [{
            type: "choroplethmap",
            locations: fire_names,
            z: fire_acres,
            geojson: fires_json,
            featureidkey: "properties.FIRE_NAME",
            marker : {opacity: 0.75},
        }];

        var layout = {
            title: {
                text: "Recent Large Fire Perimeters (GT 5000 acres)"
            },
            map: {
                center: {lon: -117, lat: 35},
                zoom: 3.5,
            }
        };

        Plotly.newPlot("map", data, layout, 
            {margin: { t: 0, l: 0, r: 0, b: 0 }},
            {responsive: true}
        ).then(function() {
            hide_spinner();
        });

        const bar1_data = [{
            x: fire_cause.slice(1, fire_cause.length),
            y: cause_freq,
            type: "bar",
            marker: {color: "rgb(240, 130, 5)"}
            //orientation: "h"
        }];
        const bar1_layout = {
            title: {
                text: "Cause of fires"
            }
        };

        Plotly.newPlot("bar1", bar1_data, bar1_layout);

        const bar2_data = [{
            x: months,
            y: month_freq,
            type: "bar",
            //orientation: "h"
        }];
        const bar2_layout = {
            title: {
                text: "Months when fires started"
            }
        };
        Plotly.newPlot("bar2", bar2_data, bar2_layout);

        const scatter1_data = [{
            x: days_to_contain,
            y: fire_acres,
            mode: "markers",
            text: fire_names,
            marker: {size: 12, color: "rgb(66, 128, 65)"},
            type: "scatter",
        }];
        const scatter1_layout = {
            title: {
                text: "Size of fire vs days needed to contain it"
            }
        };
        Plotly.newPlot("scatter1", scatter1_data, scatter1_layout);

        // TODO idea: info box shows up top right instead of alert?
        // other cool events: https://plotly.com/javascript/plotlyjs-events/
        var map_plot = document.getElementById("map");
        map_plot.on("plotly_click", function(data) {
            const p = data.points[0].properties;
            const message = "Fire Name: " + p.FIRE_NAME + "\n" +
                "Acres burned: " + p.GIS_ACRES + "\n" +
                "Alarm Date: " + p.ALARM_DATE + "\n" +
                "Containment Date: " + p.CONT_DATE + "\n" +
                "Cause: " + fire_cause[parseInt(p.CAUSE)] + "\n" +
                "Additional Comments: " + (p.COMMENTS ?? "None");
            alert(message);
        });
    </script>
</body>
</html>
